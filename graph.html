<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Graph by t (directed trace + relayout)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
  html, body { height: 100%; margin: 0; }
  .row {
    padding: 8px 12px; border-bottom: 1px solid #e5e7eb;
    display: flex; gap: 16px; flex-wrap: wrap; align-items: center;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  #legend, #vlegend { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .chip { display: inline-flex; gap: 6px; align-items: center;
          padding: 2px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
  .swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  #network { width: 100%; height: calc(100% - 168px); }
  label { user-select: none; }
  .btn { padding: 4px 10px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }
  div.vis-network div.vis-tooltip { white-space: pre-line; max-width: 520px; }
</style>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
  <div class="row">
    <div><strong>t columns:</strong> 1, 2, 3, 4, 5, 6, 7, 8</div>
    <div><strong>zones:</strong> (NA), 308.0, 317.0</div>
    <label><input type="checkbox" id="toggleLabels"> show labels</label>
    <label title="只保留 flow>0 的边，并隐藏未参与这些边的节点">
      <input type="checkbox" id="flowOnly"> flow-only
    </label>
    <label><input type="checkbox" id="showVirtual" checked> show virtual nodes</label>
  </div>

  <div class="row">
    <div id="legend"><strong>Edge types:</strong><label class="chip"><span class="swatch" style="background:#1f77b4"></span><input type="checkbox" class="etype" value="from_source" checked/> from_source</label><label class="chip"><span class="swatch" style="background:#ff7f0e"></span><input type="checkbox" class="etype" value="idle" checked/> idle</label><label class="chip"><span class="swatch" style="background:#2ca02c"></span><input type="checkbox" class="etype" value="reposition" checked/> reposition</label><label class="chip"><span class="swatch" style="background:#d62728"></span><input type="checkbox" class="etype" value="to_sink" checked/> to_sink</label></div>
  </div>

  <div class="row">
    <div id="vlegend"><strong>Virtual categories:</strong><label class="chip"><span class="swatch" style="background:#06b6d4"></span><input type="checkbox" class="vcat" value="charging" checked/> charging</label><label class="chip"><span class="swatch" style="background:#ef4444"></span><input type="checkbox" class="vcat" value="service" checked/> service</label><label class="chip"><span class="swatch" style="background:#9ca3af"></span><input type="checkbox" class="vcat" value="unknown" checked/> unknown</label></div>
  </div>

  <div class="row">
    <label title="点击节点后，仅显示该节点与其所有直连边及对端节点，并动态重排">
      <input type="checkbox" id="focusOnClick"> focus on click
    </label>
    <button class="btn" id="clearFocus" title="退出聚焦并恢复原始布局">clear</button>

    <label title="点击节点后，仅保留其在 flow>0 的有向通路，并按层级动态重排">
      <input type="checkbox" id="tracePath"> trace path (flow)
    </label>
    <span>
      path dir:
      <label><input type="radio" name="pathdir" value="forward"> forward</label>
      <label><input type="radio" name="pathdir" value="backward"> backward</label>
      <label><input type="radio" name="pathdir" value="both" checked> both</label>
    </span>
    <button class="btn" id="clearPath" title="关闭通路模式并恢复筛选">clear path</button>
  </div>

  <div id="network"></div>

  <script>
    const ALL_NODES = [{"id": "10", "label": " ", "title": "Node: 10\nt: 1\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 0.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "21", "label": " ", "title": "Node: 21\nt: 2\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 260.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "28", "label": " ", "title": "Node: 28\nt: 3\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 507.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "32", "label": " ", "title": "Node: 32\nt: 3\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 533.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "39", "label": " ", "title": "Node: 39\nt: 4\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 767.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "43", "label": " ", "title": "Node: 43\nt: 4\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 793.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "46", "label": " ", "title": "Node: 46\nt: 5\nzone: 308.0\nsoc: 20\nsupply: 0", "x": 1027.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "50", "label": " ", "title": "Node: 50\nt: 5\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 1053.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "54", "label": " ", "title": "Node: 54\nt: 5\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 1027.0, "y": -407.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "57", "label": " ", "title": "Node: 57\nt: 6\nzone: 308.0\nsoc: 20\nsupply: 0", "x": 1287.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "61", "label": " ", "title": "Node: 61\nt: 6\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 1313.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "65", "label": " ", "title": "Node: 65\nt: 6\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 1287.0, "y": -407.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "68", "label": " ", "title": "Node: 68\nt: 7\nzone: 308.0\nsoc: 20\nsupply: 0", "x": 1547.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "72", "label": " ", "title": "Node: 72\nt: 7\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 1573.0, "y": -433.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "76", "label": " ", "title": "Node: 76\nt: 7\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 1547.0, "y": -407.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "77", "label": " ", "title": "Node: 77\nt: 8\nzone: 308.0\nsoc: 0\nsupply: 0", "x": 1781.0, "y": -446.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "78", "label": " ", "title": "Node: 78\nt: 8\nzone: 308.0\nsoc: 10\nsupply: 0", "x": 1807.0, "y": -446.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "79", "label": " ", "title": "Node: 79\nt: 8\nzone: 308.0\nsoc: 20\nsupply: 0", "x": 1833.0, "y": -446.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "80", "label": " ", "title": "Node: 80\nt: 8\nzone: 308.0\nsoc: 30\nsupply: 0", "x": 1859.0, "y": -446.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "81", "label": " ", "title": "Node: 81\nt: 8\nzone: 308.0\nsoc: 40\nsupply: 0", "x": 1781.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "82", "label": " ", "title": "Node: 82\nt: 8\nzone: 308.0\nsoc: 50\nsupply: 0", "x": 1807.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "83", "label": " ", "title": "Node: 83\nt: 8\nzone: 308.0\nsoc: 60\nsupply: 0", "x": 1833.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "84", "label": " ", "title": "Node: 84\nt: 8\nzone: 308.0\nsoc: 70\nsupply: 0", "x": 1859.0, "y": -420.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "85", "label": " ", "title": "Node: 85\nt: 8\nzone: 308.0\nsoc: 80\nsupply: 0", "x": 1781.0, "y": -394.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "86", "label": " ", "title": "Node: 86\nt: 8\nzone: 308.0\nsoc: 90\nsupply: 0", "x": 1807.0, "y": -394.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "87", "label": " ", "title": "Node: 87\nt: 8\nzone: 308.0\nsoc: 100\nsupply: 0", "x": 1833.0, "y": -394.0, "fixed": true, "group": "zone_308.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "98", "label": " ", "title": "Node: 98\nt: 1\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 0.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "109", "label": " ", "title": "Node: 109\nt: 2\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 260.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "116", "label": " ", "title": "Node: 116\nt: 3\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 507.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "120", "label": " ", "title": "Node: 120\nt: 3\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 533.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "127", "label": " ", "title": "Node: 127\nt: 4\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 767.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "131", "label": " ", "title": "Node: 131\nt: 4\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 793.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "138", "label": " ", "title": "Node: 138\nt: 5\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 1027.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "142", "label": " ", "title": "Node: 142\nt: 5\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 1053.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "149", "label": " ", "title": "Node: 149\nt: 6\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 1287.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "153", "label": " ", "title": "Node: 153\nt: 6\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 1313.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "160", "label": " ", "title": "Node: 160\nt: 7\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 1547.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "164", "label": " ", "title": "Node: 164\nt: 7\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 1573.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "165", "label": " ", "title": "Node: 165\nt: 8\nzone: 317.0\nsoc: 0\nsupply: 0", "x": 1781.0, "y": -866.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "166", "label": " ", "title": "Node: 166\nt: 8\nzone: 317.0\nsoc: 10\nsupply: 0", "x": 1807.0, "y": -866.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "167", "label": " ", "title": "Node: 167\nt: 8\nzone: 317.0\nsoc: 20\nsupply: 0", "x": 1833.0, "y": -866.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "168", "label": " ", "title": "Node: 168\nt: 8\nzone: 317.0\nsoc: 30\nsupply: 0", "x": 1859.0, "y": -866.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "169", "label": " ", "title": "Node: 169\nt: 8\nzone: 317.0\nsoc: 40\nsupply: 0", "x": 1781.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "170", "label": " ", "title": "Node: 170\nt: 8\nzone: 317.0\nsoc: 50\nsupply: 0", "x": 1807.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "171", "label": " ", "title": "Node: 171\nt: 8\nzone: 317.0\nsoc: 60\nsupply: 0", "x": 1833.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "172", "label": " ", "title": "Node: 172\nt: 8\nzone: 317.0\nsoc: 70\nsupply: 0", "x": 1859.0, "y": -840.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "173", "label": " ", "title": "Node: 173\nt: 8\nzone: 317.0\nsoc: 80\nsupply: 0", "x": 1781.0, "y": -814.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "174", "label": " ", "title": "Node: 174\nt: 8\nzone: 317.0\nsoc: 90\nsupply: 0", "x": 1807.0, "y": -814.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "175", "label": " ", "title": "Node: 175\nt: 8\nzone: 317.0\nsoc: 100\nsupply: 0", "x": 1833.0, "y": -814.0, "fixed": true, "group": "zone_317.0", "is_virtual": false, "vcat": "", "shape": "dot", "size": 8}, {"id": "-2065537959644669696", "label": " ", "title": "Node: -2065537959644669696\nt: virtual\nzone: (NA)\nvirtual category: unknown\nsupply: 200", "x": 0.0, "y": 420.0, "fixed": true, "group": "zone_(NA)", "is_virtual": true, "vcat": "unknown", "shape": "diamond", "size": 8, "color": {"background": "#9ca3af", "border": "#9ca3af"}}, {"id": "-8724511148913573888", "label": " ", "title": "Node: -8724511148913573888\nt: virtual\nzone: (NA)\nvirtual category: unknown\nsupply: -200", "x": 1820.0, "y": 420.0, "fixed": true, "group": "zone_(NA)", "is_virtual": true, "vcat": "unknown", "shape": "diamond", "size": 8, "color": {"background": "#9ca3af", "border": "#9ca3af"}}];
    const ALL_EDGES = [{"from": "61", "to": "72", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 61 → 72\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "109", "to": "120", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 109 → 120\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "164", "to": "175", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 164 → 175\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "116", "to": "127", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 116 → 127\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "68", "to": "79", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 68 → 79\ntype: idle\nflow: 200\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 200.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "127", "to": "138", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 127 → 138\ntype: idle\nflow: 200\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 200.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "39", "to": "50", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 39 → 50\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "28", "to": "39", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 28 → 39\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "54", "to": "65", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 54 → 65\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "43", "to": "54", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 43 → 54\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "138", "to": "149", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 138 → 149\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "21", "to": "32", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 21 → 32\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "72", "to": "83", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 72 → 83\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "46", "to": "57", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 46 → 57\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "76", "to": "87", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 76 → 87\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "57", "to": "68", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 57 → 68\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "153", "to": "164", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 153 → 164\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "65", "to": "76", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 65 → 76\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "32", "to": "43", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 32 → 43\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "160", "to": "171", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 160 → 171\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "149", "to": "160", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 149 → 160\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "120", "to": "131", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 120 → 131\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "10", "to": "21", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 10 → 21\ntype: idle\nflow: 200\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 200.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "131", "to": "142", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 131 → 142\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "98", "to": "109", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 98 → 109\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "50", "to": "61", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 50 → 61\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "142", "to": "153", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 142 → 153\ntype: idle\nflow: 0\ncost: 10\ncapacity: ∞", "edge_type": "idle", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#ff7f0e"}}, {"from": "109", "to": "39", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 109 → 39\ntype: reposition\nflow: 0\ncost: 1.9\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "43", "to": "149", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 43 → 149\ntype: reposition\nflow: 0\ncost: 1.9555555555555555\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "21", "to": "127", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 21 → 127\ntype: reposition\nflow: 200\ncost: 1.9\ncapacity: ∞", "edge_type": "reposition", "flow": 200.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "54", "to": "160", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 54 → 160\ntype: reposition\nflow: 0\ncost: 1.9555555555555555\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "153", "to": "83", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 153 → 83\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "142", "to": "72", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 142 → 72\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "32", "to": "138", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 32 → 138\ntype: reposition\nflow: 0\ncost: 1.9555555555555555\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "98", "to": "28", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 98 → 28\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "10", "to": "116", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 10 → 116\ntype: reposition\nflow: 0\ncost: 1.9555555555555555\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "116", "to": "46", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 116 → 46\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "127", "to": "57", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 127 → 57\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "138", "to": "68", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 138 → 68\ntype: reposition\nflow: 200\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 200.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "131", "to": "61", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 131 → 61\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "149", "to": "79", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 149 → 79\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "65", "to": "171", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 65 → 171\ntype: reposition\nflow: 0\ncost: 1.9555555555555555\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "120", "to": "50", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 120 → 50\ntype: reposition\nflow: 0\ncost: 1.8444444444444446\ncapacity: ∞", "edge_type": "reposition", "flow": 0.0, "dashes": false, "label": "∞", "color": {"color": "#2ca02c"}}, {"from": "-2065537959644669696", "to": "10", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: -2065537959644669696 → 10\ntype: from_source\nflow: 200\ncost: 0\ncapacity: ∞", "edge_type": "from_source", "flow": 200.0, "dashes": true, "label": "∞", "color": {"color": "#1f77b4"}}, {"from": "-2065537959644669696", "to": "98", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: -2065537959644669696 → 98\ntype: from_source\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "from_source", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#1f77b4"}}, {"from": "165", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 165 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "166", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 166 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "167", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 167 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "168", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 168 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "169", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 169 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "170", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 170 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "171", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 171 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "172", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 172 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "173", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 173 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "174", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 174 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "175", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 175 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "77", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 77 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "78", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 78 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "79", "to": "-8724511148913573888", "arrows": "to", "width": 6, "smooth": false, "title": "Edge: 79 → -8724511148913573888\ntype: to_sink\nflow: 200\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 200.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "80", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 80 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "81", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 81 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "82", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 82 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "83", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 83 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "84", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 84 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "85", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 85 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "86", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 86 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}, {"from": "87", "to": "-8724511148913573888", "arrows": "to", "width": 1, "smooth": false, "title": "Edge: 87 → -8724511148913573888\ntype: to_sink\nflow: 0\ncost: 0\ncapacity: ∞", "edge_type": "to_sink", "flow": 0.0, "dashes": true, "label": "∞", "color": {"color": "#d62728"}}];
    const FOCUS = { xGap: 260, yGap: 110, maxCols: 6, centerSize: 11 };
    const PATH  = { xGap: 260,  yGap: 110,  maxCols: 7, centerSize: 11 };

    const nodes = new vis.DataSet(ALL_NODES);
    let edges = new vis.DataSet(ALL_EDGES);

    const options = {
      physics: false,
      interaction: { hover: true, zoomView: true, dragView: true },
      nodes: { shape: 'dot', font: { size: 1 } },
      edges: { 
        smooth: false, 
        arrows: 'to',
        font: { size: 12, color: '#333' },
        labelHighlightBold: false
      }
    };
    const network = new vis.Network(document.getElementById('network'), { nodes, edges }, options);

    // 保存原始坐标用于恢复
    const ORIG_POS = {};
    nodes.get().forEach(n => { ORIG_POS[n.id] = { x: n.x, y: n.y, size: n.size ?? 8 }; });

    // 状态
    let focusedNodeId = null;
    let tracedCenterId = null;

    // 标签切换
    document.getElementById('toggleLabels').addEventListener('change', e => {
      const show = e.target.checked;
      nodes.update(nodes.get().map(n => ({ id: n.id, label: show ? String(n.id) : ' ' })));
    });

    function getPathDir() {
      const el = document.querySelector('input[name="pathdir"]:checked');
      return el ? el.value : 'both';
    }

    // 点击优先级：trace path > focus
    network.on('click', params => {
      if (!(params.nodes && params.nodes.length > 0)) return;
      const nid = String(params.nodes[0]);
      if (document.getElementById('tracePath').checked) {
        tracedCenterId = nid; focusedNodeId = null; applyFilters(); return;
      }
      if (document.getElementById('focusOnClick').checked) {
        focusedNodeId = nid; tracedCenterId = null; applyFilters();
      }
    });
    document.getElementById('clearFocus').addEventListener('click', () => { focusedNodeId = null; applyFilters(); });
    document.getElementById('clearPath').addEventListener('click', () => { tracedCenterId = null; applyFilters(); });
    document.querySelectorAll('input[name="pathdir"]').forEach(r => r.addEventListener('change', () => {
      if (tracedCenterId !== null && document.getElementById('tracePath').checked) applyFilters();
    }));

    function restoreOriginalLayout() {
      const upd = nodes.get().map(n => ({
        id: n.id, x: ORIG_POS[n.id]?.x, y: ORIG_POS[n.id]?.y,
        size: ORIG_POS[n.id]?.size ?? n.size, fixed: true, hidden: n.hidden
      }));
      nodes.update(upd);
    }

    // 网格摆放
    function gridPlace(list, baseX, baseY, gapX, gapY, maxCols) {
      const n = list.length; if (n === 0) return {};
      const cols = Math.min(maxCols, Math.max(1, Math.ceil(Math.sqrt(n))));
      const rows = Math.ceil(n / cols);
      const pos = {};
      for (let i = 0; i < n; i++) {
        const r = Math.floor(i / cols), c = i % cols;
        const x = baseX + (c - (cols - 1) / 2) * (gapX / 2);
        const y = baseY + (r - (rows - 1) / 2) * gapY;
        pos[list[i]] = { x, y };
      }
      return pos;
    }

    // ======= 有向通路（flow>0） + 动态重排 =======
    function showDirectedPathRelayout(centerId, dir) {
      // 1) 仅 flow>0 的有向邻接
      const outAdj = new Map(), inAdj = new Map();
      const posEdges = [];
      for (const e of ALL_EDGES) {
        if (!(e.flow > 0)) continue;
        posEdges.push(e);
        if (!outAdj.has(e.from)) outAdj.set(e.from, []);
        if (!inAdj.has(e.to))    inAdj.set(e.to, []);
        outAdj.get(e.from).push(e.to);
        inAdj.get(e.to).push(e.from);
      }

      // 2) BFS 距离
      function bfs(start, adjMap) {
        const dist = new Map([[start, 0]]), q = [start];
        while (q.length) {
          const u = q.shift();
          for (const v of (adjMap.get(u) || [])) {
            if (!dist.has(v)) { dist.set(v, dist.get(u) + 1); q.push(v); }
          }
        }
        return dist;
      }
      const distF = (dir === 'forward' || dir === 'both') ? bfs(centerId, outAdj) : new Map([[centerId,0]]);
      const distB = (dir === 'backward' || dir === 'both') ? bfs(centerId, inAdj ) : new Map([[centerId,0]]);

      // 3) 选节点并分层（左负右正）
      const keep = new Set([centerId]);
      for (const k of distF.keys()) keep.add(k);
      for (const k of distB.keys()) keep.add(k);

      const layer = new Map([[centerId, 0]]);
      keep.forEach(nid => {
        if (nid === centerId) return;
        const inF = distF.has(nid), inB = distB.has(nid);
        if (dir === 'forward' && inF) layer.set(nid, +distF.get(nid));
        else if (dir === 'backward' && inB) layer.set(nid, -distB.get(nid));
        else if (dir === 'both') {
          if (inF && !inB) layer.set(nid, +distF.get(nid));
          else if (!inF && inB) layer.set(nid, -distB.get(nid));
          else if (inF && inB) layer.set(nid, (distF.get(nid) <= distB.get(nid)) ? +distF.get(nid) : -distB.get(nid));
        }
      });

      // 4) 布局与显示
      const byLayer = new Map();
      for (const nid of keep) {
        const lv = layer.get(nid); if (lv === undefined) continue;
        if (!byLayer.has(lv)) byLayer.set(lv, []);
        byLayer.get(lv).push(nid);
      }
      nodes.update(nodes.get().map(n => ({ id: n.id, hidden: !keep.has(n.id) })));

      const updates = [{ id: centerId, x: 0, y: 0, size: PATH.centerSize, fixed: true }];
      for (const [lv, arr] of Array.from(byLayer.entries()).sort((a,b)=>a[0]-b[0])) {
        if (lv === 0) continue;
        const baseX = lv * PATH.xGap, baseY = 0;
        const pos = gridPlace(arr, baseX, baseY, PATH.xGap, PATH.yGap, PATH.maxCols);
        for (const [id,p] of Object.entries(pos)) updates.push({ id, x:p.x, y:p.y, fixed:true });
      }
      nodes.update(updates);

      // 5) 仅显示通路上的 flow>0 边
      const keepEdges = [];
      const seen = new Set();
      for (const e of posEdges) {
        if (keep.has(e.from) && keep.has(e.to)) {
          const key = e.from + "->" + e.to + "|" + e.edge_type + "|" + (e.cost ?? "");
          if (!seen.has(key)) { seen.add(key); keepEdges.push({ ...e, hidden: false }); }
        }
      }
      edges.clear(); edges.add(keepEdges);

      // 视图对齐
      network.fit({ nodes: Array.from(keep), animation: { duration: 250, easingFunction: "easeInOutQuad" } });
    }

    // ======= 聚焦动态重排 =======
    function relayoutFocus(centerId) {
      const inSet  = new Set();
      const outSet = new Set();
      ALL_EDGES.forEach(e => { if (e.to === centerId && !inSet.has(e.from)) inSet.add(e.from);
                               if (e.from === centerId && !outSet.has(e.to)) outSet.add(e.to); });
      const biSet = new Set();
      for (const n of Array.from(inSet)) if (outSet.has(n)) { biSet.add(n); inSet.delete(n); outSet.delete(n); }

      const inList  = Array.from(inSet);
      const outList = Array.from(outSet);
      const biList  = Array.from(biSet);

      const keep = new Set([centerId, ...inList, ...outList, ...biList]);
      nodes.update(nodes.get().map(n => ({ id: n.id, hidden: !keep.has(n.id) })));

      const updates = [{ id: centerId, x: 0, y: 0, size: FOCUS.centerSize, fixed: true }];
      const posIn  = gridPlace(inList,  -FOCUS.xGap, 0, FOCUS.xGap, FOCUS.yGap, FOCUS.maxCols);
      const posOut = gridPlace(outList, +FOCUS.xGap, 0, FOCUS.xGap, FOCUS.yGap, FOCUS.maxCols);
      const posBi  = gridPlace(biList,  0, FOCUS.yGap*1.4, FOCUS.xGap, FOCUS.yGap, FOCUS.maxCols);
      for (const [id,p] of Object.entries(posIn))  updates.push({ id, x:p.x, y:p.y, fixed:true });
      for (const [id,p] of Object.entries(posOut)) updates.push({ id, x:p.x, y:p.y, fixed:true });
      for (const [id,p] of Object.entries(posBi))  updates.push({ id, x:p.x, y:p.y, fixed:true });
      nodes.update(updates);

      const focusEdges = ALL_EDGES.filter(e => e.from === centerId || e.to === centerId).map(e => ({ ...e, hidden: false }));
      edges.clear(); edges.add(focusEdges);
      network.fit({ nodes: Array.from(keep), animation: { duration: 250, easingFunction: "easeInOutQuad" } });
    }

    // 统一过滤
    function applyFilters() {
      // 1) 通路模式（有向 + 动态重排）
      if (tracedCenterId !== null && document.getElementById('tracePath').checked) {
        restoreOriginalLayout();  // 先恢复坐标，再重排通路
        showDirectedPathRelayout(tracedCenterId, getPathDir());
        return;
      }
      // 2) 聚焦模式
      if (focusedNodeId !== null && document.getElementById('focusOnClick').checked) {
        relayoutFocus(focusedNodeId);
        return;
      }

      // 3) 常规筛选
      const allowedEdgeTypes = new Set(Array.from(document.querySelectorAll('.etype')).filter(b => b.checked).map(b => b.value));
      const allowedVCats    = new Set(Array.from(document.querySelectorAll('.vcat')).filter(b => b.checked).map(b => b.value));
      const flowOnly        = document.getElementById('flowOnly').checked;
      const showVirtual     = document.getElementById('showVirtual').checked;

      const hiddenInit = new Set();
      nodes.get().forEach(n => {
        if (n.is_virtual) {
          const ok = showVirtual && allowedVCats.has(n.vcat);
          if (!ok) hiddenInit.add(n.id);
        }
      });

      const candidateEdges = ALL_EDGES.filter(e =>
        allowedEdgeTypes.has(e.edge_type) && (!flowOnly || e.flow > 0)
      );

      const activeNodeIds = new Set();
      candidateEdges.forEach(e => {
        if (!hiddenInit.has(e.from) && !hiddenInit.has(e.to)) {
          activeNodeIds.add(e.from); activeNodeIds.add(e.to);
        }
      });

      const finalHidden = new Set(hiddenInit);
      if (flowOnly) {
        nodes.get().forEach(n => {
          if (!finalHidden.has(n.id) && !activeNodeIds.has(n.id)) finalHidden.add(n.id);
        });
      }

      restoreOriginalLayout();
      nodes.update(nodes.get().map(n => ({ id: n.id, hidden: finalHidden.has(n.id) })));

      const filtered = ALL_EDGES.map(e => ({
        ...e,
        hidden: !(
          allowedEdgeTypes.has(e.edge_type) &&
          (!flowOnly || e.flow > 0) &&
          !finalHidden.has(e.from) &&
          !finalHidden.has(e.to)
        )
      }));
      edges.clear(); edges.add(filtered);
    }

    // 常规控件
    document.getElementById('flowOnly').addEventListener('change', applyFilters);
    document.getElementById('showVirtual').addEventListener('change', applyFilters);
    document.querySelectorAll('.etype').forEach(b => b.addEventListener('change', applyFilters));
    document.querySelectorAll('.vcat').forEach(b => b.addEventListener('change', applyFilters));
  </script>
</body>
</html>
