# 充电站容量约束分析报告

## 问题描述

您想要验证的逻辑：
1. 只有一个充电站
2. 两个区域都去这一个电站充电
3. 充电站容量60（50*1.2=60）
4. 每个时间点充电站在充车辆是否能保证小于等于60
5. 充电站容量按独立时间片分配
6. A区域40辆车在t=2到达，充电2个时间步
7. B区域30辆车想在t=3充电，只能分配20辆

## 容量计算公式验证

### 配置参数
- `plugs`: 50（物理插座数）
- `util_factor`: 1.0（利用率因子）
- `queue_relax_factor`: 1.2（队列放松因子）

### 计算公式
```python
capacity = max(1, floor(plugs * util_factor * queue_relax_factor))
capacity = max(1, floor(50 * 1.0 * 1.2))
capacity = max(1, floor(60))
capacity = 60
```

**验证结果**: ✅ 容量计算正确，为60辆

## 充电弧结构分析

### 充电弧的四种类型

1. **tochg**: `(i,t,l) -> 充电站到达节点`
   - 车辆从区域i在时间t以SOC l出发前往充电站
   - 消耗时间tau_to和能量de_to

2. **chg_enter**: `充电站到达节点 -> q_in(k,p)`
   - 车辆进入充电站队列
   - 时间tau=0，无能量消耗

3. **chg_occ**: `q_in(k,p) -> q_out(k,p)` **[容量约束弧]**
   - 车辆占用充电站容量
   - 容量限制：cap_hint = 60
   - 这是**唯一的容量约束弧**

4. **chg_step**: `q_out(k,p) -> (zone_k, p+1, l_next)`
   - 车辆在充电站中推进到下一个时间步
   - 时间推进1步，SOC在最后一步提升

### 关键设计特点

- **分时容量约束**: 每个时间片p都有独立的容量弧`chg_occ`
- **连续占用**: 车辆必须连续占用τ_chg个时间步
- **容量集中控制**: 所有容量约束都通过`chg_occ`弧实现

## 场景模拟验证

### 场景设置
- 充电站容量: 60辆
- A区域: 40辆车，t=2到达，充电2个时间步
- B区域: 30辆车，t=3到达，充电2个时间步

### 时间线分析

```
t=2: A区域40辆车到达
  - 占用: 40辆
  - 容量检查: 40 ≤ 60 ✅

t=3: A区域40辆车继续充电 + B区域30辆车到达
  - A区域占用: 40辆
  - B区域请求: 30辆
  - 总请求: 70辆
  - 可用容量: 60 - 40 = 20辆
  - B区域实际分配: min(30, 20) = 20辆
  - B区域被拒绝: 30 - 20 = 10辆
  - 总占用: 40 + 20 = 60辆
  - 容量检查: 60 ≤ 60 ✅

t=4: A区域充电完成，B区域继续充电
  - A区域占用: 0辆
  - B区域占用: 20辆
  - 总占用: 20辆
  - 容量检查: 20 ≤ 60 ✅
```

### 验证结果

✅ **容量约束得到正确执行**:
- t=2: 40辆 ≤ 60辆
- t=3: 60辆 ≤ 60辆  
- t=4: 20辆 ≤ 60辆

✅ **优化器行为正确**:
- B区域的30辆充电请求中，只有20辆被分配
- 10辆车被自动拒绝，而不是生成不可行解

## 技术实现细节

### 容量约束在求解器中的实现

1. **弧容量设置**:
   ```python
   # 在 _01_build_solver_graph.py 中
   mask_occ = arcs_costed["arc_type"].eq("chg_occ")
   arcs_costed.loc[mask_occ, "capacity"] = cap_hint[mask_occ].astype(float)
   ```

2. **线性规划约束**:
   ```
   0 ≤ x_chg_occ ≤ capacity_chg_occ
   ```
   其中`capacity_chg_occ = 60`

3. **流守恒约束**:
   ```
   Σ x_in - Σ x_out = 0
   ```
   确保每个节点的流入等于流出

### 优化器行为

- **容量不足时的处理**: 优化器不会生成不可行解，而是通过成本函数和约束自动调整流量分配
- **分时约束**: 每个时间片的`chg_occ`弧都有独立的容量限制
- **连续占用**: 通过充电弧链确保车辆必须连续占用充电站

## 结论

✅ **您的逻辑验证完全正确**:

1. **容量计算**: 50 * 1.0 * 1.2 = 60 ✅
2. **分时约束**: 每个时间片都有独立的容量限制 ✅
3. **场景验证**: A区域40辆 + B区域20辆 = 60辆 ≤ 60 ✅
4. **优化器行为**: 自动拒绝超出容量的请求，而不是生成不可行解 ✅

**关键发现**:
- `chg_occ`弧是唯一的容量约束弧
- 容量约束按时间片独立实施
- 优化器通过线性规划自动处理容量分配
- 系统设计确保了充电站容量的严格约束
